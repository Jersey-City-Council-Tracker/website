<% content_for(:title, "Search - CouncilTracker") %>

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-2xl font-bold text-gray-900">Search Agenda Items</h1>
  <p class="mt-2 text-sm text-gray-600">Find ordinances, resolutions, and other items across all meetings.</p>

  <%# Filter Form %>
  <div class="mt-6 bg-white rounded-lg border border-gray-200 p-8" data-controller="search-filters">
    <%= form_with url: search_path, method: :get, local: true do |f| %>
      <div class="space-y-6">
        <%# Row 1: Text search + File number %>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="q" class="block text-sm font-medium text-gray-700">Search title</label>
            <input type="text" name="q" id="q" value="<%= params[:q] %>"
                   placeholder="e.g. parking, tax abatement..."
                   class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
          </div>
          <div>
            <label for="file_number" class="block text-sm font-medium text-gray-700">File number</label>
            <input type="text" name="file_number" id="file_number" value="<%= params[:file_number] %>"
                   placeholder="e.g. Ord. 26-009"
                   class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
          </div>
        </div>

        <%# Row 2: Council member + Vote position %>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="council_member_id" class="block text-sm font-medium text-gray-700">Council member</label>
            <select name="council_member_id" id="council_member_id"
                    data-search-filters-target="councilMember"
                    data-action="change->search-filters#toggleVoteFilter"
                    class="mt-1 block w-full h-[42px] rounded-md border border-gray-300 px-3 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="">All members</option>
              <% @council_members.each do |member| %>
                <option value="<%= member.id %>" <%= "selected" if params[:council_member_id] == member.id.to_s %>><%= member.display_name %></option>
              <% end %>
            </select>
          </div>
          <div data-search-filters-target="voteFilterWrapper">
            <label for="vote_position" class="block text-sm font-medium text-gray-700">Vote position</label>
            <select name="vote_position" id="vote_position"
                    data-search-filters-target="votePosition"
                    class="mt-1 block w-full h-[42px] rounded-md border border-gray-300 px-3 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="">Any vote</option>
              <% %w[aye nay abstain absent].each do |position| %>
                <option value="<%= position %>" <%= "selected" if params[:vote_position] == position %>><%= position.capitalize %></option>
              <% end %>
            </select>
          </div>
        </div>

        <%# Row 3: Topic + Result %>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="tag_id" class="block text-sm font-medium text-gray-700">Topic</label>
            <select name="tag_id" id="tag_id"
                    class="mt-1 block w-full h-[42px] rounded-md border border-gray-300 px-3 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="">All topics</option>
              <% @tags.each do |tag| %>
                <option value="<%= tag.id %>" <%= "selected" if params[:tag_id] == tag.id.to_s %>><%= tag.name %></option>
              <% end %>
            </select>
          </div>
          <div>
            <label for="result" class="block text-sm font-medium text-gray-700">Result</label>
            <select name="result" id="result"
                    class="mt-1 block w-full h-[42px] rounded-md border border-gray-300 px-3 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="">Any result</option>
              <% AgendaItem::VALID_RESULTS.each do |result| %>
                <option value="<%= result %>" <%= "selected" if params[:result] == result %>><%= result.capitalize %></option>
              <% end %>
            </select>
          </div>
        </div>

        <%# Row 4: Date range %>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="date_from" class="block text-sm font-medium text-gray-700">From date</label>
            <input type="date" name="date_from" id="date_from" value="<%= params[:date_from] %>"
                   class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
          </div>
          <div>
            <label for="date_to" class="block text-sm font-medium text-gray-700">To date</label>
            <input type="date" name="date_to" id="date_to" value="<%= params[:date_to] %>"
                   class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
          </div>
        </div>

        <%# Actions %>
        <div class="flex items-center gap-4 pt-2">
          <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
            Search
          </button>
          <%= link_to "Clear filters", search_path, class: "text-sm text-gray-500 hover:text-gray-700 transition-colors" %>
        </div>
      </div>
    <% end %>
  </div>

  <%# Results %>
  <div class="mt-8">
    <% if @has_results == nil %>
      <%# No filters applied %>
      <div class="text-center py-12 text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
        </svg>
        <p class="mt-4 text-sm">Use the filters above to search agenda items across all meetings.</p>
      </div>
    <% elsif @has_results %>
      <%# Results found %>
      <p class="text-sm text-gray-600 mb-4">
        <%= @total_count %> <%= "item".pluralize(@total_count) %> found
        <% if @total_pages > 1 %>
          &middot; Page <%= @page %> of <%= @total_pages %>
        <% end %>
      </p>

      <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File #</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topics</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                <% if @selected_member_id.present? %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vote</th>
                <% end %>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @agenda_items.each do |item| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">
                    <%= link_to item.meeting.date.strftime("%b %-d, %Y"), meeting_path(item.meeting), class: "text-blue-600 hover:text-blue-800" %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    <span class="text-gray-400"><%= item.item_number %></span>
                    <%= item.title %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap"><%= item.file_number %></td>
                  <td class="px-4 py-3 text-sm">
                    <% item.tags.each do |tag| %>
                      <%= link_to tag.name, tag_path(tag), class: "inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200 mr-1" %>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 text-sm whitespace-nowrap">
                    <% if item.result.present? %>
                      <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium <%= result_badge_class(item.result) %>"><%= item.result.capitalize %></span>
                    <% end %>
                  </td>
                  <% if @selected_member_id.present? %>
                    <td class="px-4 py-3 text-sm whitespace-nowrap">
                      <% vote = @votes_by_item[item.id] %>
                      <% if vote %>
                        <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium <%= vote_badge_class(vote.position) %>"><%= vote.position.capitalize %></span>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <%# Pagination %>
      <% if @total_pages > 1 %>
        <div class="mt-4 flex items-center justify-between">
          <div>
            <% if @page > 1 %>
              <%= link_to "Previous", search_path(request.query_parameters.merge(page: @page - 1)),
                    class: "inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
            <% end %>
          </div>
          <div>
            <% if @page < @total_pages %>
              <%= link_to "Next", search_path(request.query_parameters.merge(page: @page + 1)),
                    class: "inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
            <% end %>
          </div>
        </div>
      <% end %>

    <% else %>
      <%# No results %>
      <div class="text-center py-12 text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>
        <p class="mt-4 text-sm">No agenda items match your filters. Try broadening your search.</p>
      </div>
    <% end %>
  </div>
</div>
